<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drive Controller</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 0; background:#0b0f14; color:#e6edf3; }
  .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
  button { font-size: 18px; padding: 16px; border-radius: 14px; border: 0; background:#1f2937; color:#e6edf3; }
  button:active { transform: scale(0.98); }
  .primary { background:#2563eb; }
  .danger { background:#ef4444; }
  .ok { background:#16a34a; }
  .muted { background:#374151; }
  .block { display:block; width:100%; margin: 8px 0; }
  .card { background:#111827; padding:12px; border-radius:16px; }
  .title { font-size:20px; margin: 6px 0 12px; }
  .hidden { display:none; }
  input[type=range]{ width:100%; }
  .status{ font-size:14px; opacity:0.8; }
</style>
<body>
<div class="wrap">
  <h2>Drive Controller</h2>
  <div class="card">
    <div class="row">
      <button class="primary" onclick="connect()">Connect</button>
      <button class="danger" onclick="disconnect()">Disconnect</button>
    </div>
    <div class="status" id="status">Not connected</div>
  </div>

  <div class="card">
    <div class="title">Power</div>
    <div class="row">
      <button class="ok" onclick="sysOn()">Turn ON</button>
      <button class="danger" onclick="sysOff()">Turn OFF</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Mode</div>
    <div class="row">
      <button onclick="setMode(1)">Remote</button>
      <button class="muted" onclick="setMode(2)">Auto</button>
    </div>
  </div>

  <div class="card" id="remotePanel" class="hidden">
    <div class="title">Remote Controls</div>
    <label>Speed: <span id="spdLabel">70</span>%</label>
    <input id="spd" type="range" min="0" max="100" value="70" oninput="spdLabel.textContent=this.value">
    <div class="row">
      <button onclick="remote(1)">Forward</button>
      <button onclick="remote(2)">Backward</button>
    </div>
    <div class="row">
      <button onclick="remote(3)">Left</button>
      <button onclick="remote(4)">Right</button>
    </div>
    <button class="block muted" onclick="remote(5)">Stop</button>
  </div>

  <div class="card">
    <div class="title">Features</div>
    <div class="row">
      <button onclick="feature(1)">CACC</button>
      <button onclick="feature(2)">IMA</button>
    </div>
    <div class="status">In Auto mode, UI stays idle while STM32 runs logic.</div>
  </div>
</div>

<script>
const SERVICE_UUID = '0000abcd-0000-1000-8000-00805f9b34fb';
const CHAR_UUID    = '0000dcba-0000-1000-8000-00805f9b34fb';

let device, server, writeChar, keepAliveTimer=null, mode=0;

const remotePanel = document.getElementById('remotePanel');
const statusEl = document.getElementById('status');
const spd = document.getElementById('spd');
const spdLabel = document.getElementById('spdLabel');

function setStatus(s){ statusEl.textContent = s; }

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({ filters:[{ services:[SERVICE_UUID]}] });
    server = await device.gatt.connect();
    const svc = await server.getPrimaryService(SERVICE_UUID);
    writeChar = await svc.getCharacteristic(CHAR_UUID);
    setStatus('Connected');
    startKeepAlive();
  }catch(e){ setStatus('Connect failed: '+e); }
}

function disconnect(){
  stopKeepAlive();
  if(device && device.gatt.connected) device.gatt.disconnect();
  setStatus('Disconnected');
}

function startKeepAlive(){
  stopKeepAlive();
  keepAliveTimer = setInterval(()=> sendPacket(4,0,0), 300); // TYPE=4
}
function stopKeepAlive(){
  if(keepAliveTimer){ clearInterval(keepAliveTimer); keepAliveTimer=null; }
}

function crc8(arr){
  let crc=0x00;
  for(let b of arr){
    crc ^= b;
    for(let i=0;i<8;i++){
      crc = (crc & 0x80) ? ((crc<<1)^0x31) & 0xFF : (crc<<1) & 0xFF;
    }
  }
  return crc;
}

async function sendPacket(type, value, arg){
  if(!writeChar){ setStatus('Not connected'); return; }
  const pkt = new Uint8Array([0xAA, type & 0xFF, value & 0xFF, arg & 0xFF, 0x00]);
  pkt[4] = crc8(pkt.slice(0,4));
  try{
    await writeChar.writeValueWithoutResponse(pkt);
  }catch(e){
    setStatus('Send error: '+e);
  }
}

function sysOn(){ sendPacket(0,1,0); mode=0; remotePanel.style.display='none'; }
function sysOff(){ sendPacket(0,0,0); mode=0; remotePanel.style.display='none'; }

function setMode(m){
  sendPacket(1, m, 0);
  mode = m;
  // 1=REMOTE shows panel; 2=AUTO hides panel
  remotePanel.style.display = (m===1) ? 'block' : 'none';
}

function remote(dir){
  if(mode!==1){ setStatus('Select Remote mode first'); return; }
  const speed = parseInt(spd.value,10);
  sendPacket(2, dir, speed);
}

function feature(f){ sendPacket(3, f, 0); }
</script>
</body>
</html>
